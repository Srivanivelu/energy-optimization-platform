{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1><i class="fas fa-leaf"></i> Energy Optimization Platform</h1>
    <p>Real-time analysis of renewable and non-renewable energy data</p>
</div>

<div class="card">
    <h2><i class="fas fa-calendar-alt"></i> Select Year for Analysis</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 5px; margin: 8px 0;">
        <button class="btn year-btn" onclick="loadYearData('2024')">2024</button>
        <button class="btn year-btn" onclick="loadYearData('2025')">2025</button>
        <button class="btn year-btn" onclick="loadYearData('2026')">2026</button>
        <button class="btn year-btn" onclick="loadYearData('2027')">2027</button>
        <button class="btn year-btn" onclick="loadYearData('2028')">2028</button>
        <button class="btn year-btn" onclick="loadYearData('2029')">2029</button>
        <button class="btn year-btn" onclick="loadYearData('2030')">2030</button>
        <button class="btn year-btn" onclick="loadYearData('2031')">2031</button>
        <button class="btn year-btn" onclick="loadYearData('2032')">2032</button>
        <button class="btn year-btn" onclick="loadYearData('2033')">2033</button>
    </div>
</div>

<div id="results" style="display: none;">
    <!-- Compact Stats Row -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.4rem; font-weight: 700;" id="totalMet">247.54</div>
            <div style="font-size: 0.7rem; opacity: 0.9;">BU Met</div>
        </div>
        <div style="background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%); color: white; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.4rem; font-weight: 700;" id="percentage">17.21%</div>
            <div style="font-size: 0.7rem; opacity: 0.9;">Coverage</div>
        </div>
        <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.4rem; font-weight: 700;" id="totalDemand">1437.91</div>
            <div style="font-size: 0.7rem;">Demand</div>
        </div>
        <div style="background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%); color: white; padding: 12px; border-radius: 8px; text-align: center;">
            <div style="font-size: 1.4rem; font-weight: 700;" id="gap">1190.37</div>
            <div style="font-size: 0.7rem; opacity: 0.9;">Gap</div>
        </div>
    </div>

    <!-- Fixed Height Charts Grid -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
        <div class="card">
            <h2><i class="fas fa-chart-pie"></i> Renewable Mix</h2>
            <div style="position: relative; height: 180px; width: 100%;">
                <canvas id="renewableChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-chart-bar"></i> Energy Comparison</h2>
            <div style="position: relative; height: 180px; width: 100%;">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Fixed Height Trend Chart -->
    <div class="card">
        <h2><i class="fas fa-chart-line"></i> Growth Trend</h2>
        <div style="position: relative; height: 120px; width: 100%;">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
    
    <!-- Compact Data Table -->
    <div class="card">
        <h2><i class="fas fa-table"></i> Energy Data</h2>
        <div style="max-height: 200px; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 0.85rem;">
                <thead>
                    <tr style="background: linear-gradient(45deg, #667eea, #764ba2); color: white;">
                        <th style="padding: 8px; text-align: left;">Source</th>
                        <th style="padding: 8px; text-align: right;">Renewable</th>
                        <th style="padding: 8px; text-align: right;">Non-Renewable</th>
                        <th style="padding: 8px; text-align: center;">Status</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
let renewableChart, comparisonChart, trendChart;

function loadYearData(year) {
    document.querySelectorAll('.year-btn').forEach(btn => btn.style.background = 'linear-gradient(45deg, #43cea2, #185a9d)');
    event.target.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
    
    fetch(`/api/energy_data/${year}`)
        .then(response => response.json())
        .then(data => {
            displayResults(data);
            document.getElementById('results').style.display = 'block';
        })
        .catch(error => console.error('Error:', error));
}

function displayResults(data) {
    // Update stats
    document.getElementById('totalMet').textContent = data.optimization.total_met.toFixed(1);
    document.getElementById('percentage').textContent = data.optimization.percentage.toFixed(1) + '%';
    document.getElementById('totalDemand').textContent = data.optimization.demand.toFixed(1);
    document.getElementById('gap').textContent = (data.optimization.demand - data.optimization.total_met).toFixed(1);
    
    // Update data table
    const tableBody = document.getElementById('dataTableBody');
    tableBody.innerHTML = `
        <tr style="border-bottom: 1px solid #f8f9fa;">
            <td style="padding: 6px;"><i class="fas fa-wind"></i> Wind</td>
            <td style="padding: 6px; text-align: right;">${data.renewable.wind.toFixed(1)}</td>
            <td style="padding: 6px; text-align: right;">-</td>
            <td style="padding: 6px; text-align: center;"><span style="color: #00b894; font-size: 0.8rem;">✓</span></td>
        </tr>
        <tr style="border-bottom: 1px solid #f8f9fa;">
            <td style="padding: 6px;"><i class="fas fa-sun"></i> Solar</td>
            <td style="padding: 6px; text-align: right;">${data.renewable.solar.toFixed(1)}</td>
            <td style="padding: 6px; text-align: right;">-</td>
            <td style="padding: 6px; text-align: center;"><span style="color: #00b894; font-size: 0.8rem;">✓</span></td>
        </tr>
        <tr style="border-bottom: 1px solid #f8f9fa;">
            <td style="padding: 6px;"><i class="fas fa-seedling"></i> Bio</td>
            <td style="padding: 6px; text-align: right;">${data.renewable.bio_power.toFixed(1)}</td>
            <td style="padding: 6px; text-align: right;">-</td>
            <td style="padding: 6px; text-align: center;"><span style="color: #00b894; font-size: 0.8rem;">✓</span></td>
        </tr>
        <tr style="border-bottom: 1px solid #f8f9fa;">
            <td style="padding: 6px;"><i class="fas fa-tint"></i> Hydro</td>
            <td style="padding: 6px; text-align: right;">${data.renewable.small_hydro.toFixed(1)}</td>
            <td style="padding: 6px; text-align: right;">-</td>
            <td style="padding: 6px; text-align: center;"><span style="color: #00b894; font-size: 0.8rem;">✓</span></td>
        </tr>
        <tr style="border-bottom: 1px solid #f8f9fa;">
            <td style="padding: 6px;"><i class="fas fa-fire"></i> Coal</td>
            <td style="padding: 6px; text-align: right;">-</td>
            <td style="padding: 6px; text-align: right;">${data.non_renewable.coal}</td>
            <td style="padding: 6px; text-align: center;"><span style="color: #ff7675; font-size: 0.8rem;">⚠</span></td>
        </tr>
        <tr style="border-bottom: 1px solid #f8f9fa;">
            <td style="padding: 6px;"><i class="fas fa-gas-pump"></i> Petroleum</td>
            <td style="padding: 6px; text-align: right;">-</td>
            <td style="padding: 6px; text-align: right;">${data.non_renewable.petroleum}</td>
            <td style="padding: 6px; text-align: center;"><span style="color: #ff7675; font-size: 0.8rem;">⚠</span></td>
        </tr>
        <tr>
            <td style="padding: 6px;"><i class="fas fa-burn"></i> Gas</td>
            <td style="padding: 6px; text-align: right;">-</td>
            <td style="padding: 6px; text-align: right;">${data.non_renewable.natural_gas}</td>
            <td style="padding: 6px; text-align: center;"><span style="color: #fdcb6e; font-size: 0.8rem;">⚡</span></td>
        </tr>
    `;
    
    // Create charts with fixed dimensions
    createRenewableChart(data.renewable);
    createComparisonChart(data);
    createTrendChart(data);
}

function createRenewableChart(renewable) {
    const ctx = document.getElementById('renewableChart').getContext('2d');
    if (renewableChart) renewableChart.destroy();
    
    renewableChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Wind', 'Solar', 'Bio', 'Hydro'],
            datasets: [{
                data: [renewable.wind, renewable.solar, renewable.bio_power, renewable.small_hydro],
                backgroundColor: ['#74b9ff', '#fdcb6e', '#55a3ff', '#00b894'],
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 5,
                        usePointStyle: true,
                        font: { size: 9 }
                    }
                }
            }
        }
    });
}

function createComparisonChart(data) {
    const ctx = document.getElementById('comparisonChart').getContext('2d');
    if (comparisonChart) comparisonChart.destroy();
    
    comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['RE', 'Coal', 'Oil', 'Gas'],
            datasets: [{
                data: [
                    data.optimization.total_met,
                    data.non_renewable.coal,
                    data.non_renewable.petroleum,
                    data.non_renewable.natural_gas
                ],
                backgroundColor: ['#00b894', '#ff7675', '#fd79a8', '#fdcb6e'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { 
                y: { 
                    beginAtZero: true,
                    ticks: { font: { size: 9 } }
                },
                x: { 
                    ticks: { font: { size: 9 } }
                }
            }
        }
    });
}

function createTrendChart(data) {
    const ctx = document.getElementById('trendChart').getContext('2d');
    if (trendChart) trendChart.destroy();
    
    const years = ['2024', '2025', '2026', '2027', '2028', '2029', '2030'];
    const renewable = [247.54, 267.61, 287.69, 307.76, 327.84, 347.92, 367.99];
    
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [{
                data: renewable,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { 
                y: { 
                    beginAtZero: true,
                    ticks: { font: { size: 9 } }
                },
                x: { 
                    ticks: { font: { size: 9 } }
                }
            }
        }
    });
}

window.onload = function() {
    loadYearData('2025');
};
</script>
{% endblock %}
